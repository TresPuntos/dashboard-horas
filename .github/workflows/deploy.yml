name: Deploy Dashboard to Server

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Copy .htaccess file
      run: |
        cp dashboard-files/.htaccess build/
        echo "âœ… .htaccess file copied"
        
    - name: Create deployment package
      run: |
        cd build
        tar -czf ../dashboard-deploy.tar.gz .
        echo "âœ… Deployment package created"
        
    - name: Deploy to server via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        source: "dashboard-deploy.tar.gz"
        target: "/home/tres/"
        strip_components: 0
        
    - name: Extract and deploy files
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ğŸš€ Starting deployment..."
          cd /home/tres/
          
          # Create backup of current deployment
          if [ -d "db-clientes-backup" ]; then
            rm -rf db-clientes-backup
          fi
          if [ -d "db-clientes" ]; then
            mv db-clientes db-clientes-backup
          fi
          
          # Create new directory
          mkdir -p db-clientes
          cd db-clientes
          
          # Extract new files
          tar -xzf ../dashboard-deploy.tar.gz
          
          # Set proper permissions
          chmod -R 755 .
          chmod 644 .htaccess
          
          # Clean up
          rm ../dashboard-deploy.tar.gz
          
          echo "âœ… Dashboard deployed successfully!"
          echo "ğŸŒ Available at: https://trespuntoscomunicacion.es/db-clientes/"
          
    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        password: ${{ secrets.SERVER_PASSWORD }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ğŸ” Verifying deployment..."
          ls -la /home/tres/db-clientes/
          echo "ğŸ“ Files deployed:"
          find /home/tres/db-clientes/ -type f | head -10
          
    - name: Notify deployment success
      if: success()
      run: |
        echo "ğŸ‰ Dashboard successfully deployed!"
        echo "ğŸŒ URL: https://trespuntoscomunicacion.es/db-clientes/"
        echo "ğŸ“… Deployed at: $(date)"
        
    - name: Notify deployment failure
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "ğŸ”§ Check the logs above for details"
